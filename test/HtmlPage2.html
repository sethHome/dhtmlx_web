<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" ng-app="app">
<head>
    <title></title>
    <style>
        .box {
            border: solid 1px;
            margin: 5px;
            padding: 5px;
            width: 100%;
        }
    </style>
</head>
<body ng-controller="myCtrl">

    <box1>
        <box3>
            <box2>
                <box1>
                    <box1>

                    </box1>
                </box1>
            </box2>
           
        </box3>
    </box1>

    <script src="../assets/lib/jquery/jquery-1.11.2.js"></script>
    <script src="angular.js"></script>

    <script>

        var app = angular.module("app", []);
        
        app.controller("myCtrl", function ($scope, $element, $controller, $compile) {

        });

        app.directive("box1", function () {
            return {
                restrict: 'E',
                template: '<div class="box" >{{$id}}-{{level}},parent:{{parents.length}},children:{{children.length}}<div ng-transclude></div></div>',
                replace: true,
                transclude: true,
                require: ['box1','?^^box1', '?^box2', '?^box3'],
                controller: function ($scope) {
                    this.$scope = $scope;
                    this.$scope.level = "box1";
                    this.$scope.parents = [];
                    this.$scope.children = [];

                    this.setParent = function (ctrl) {
                        ctrl.$scope.parents.push(this);
                        this.$scope.children.push(ctrl);
                    }
                },
                scope: true,
                link: function (scope, element, attrs, ctrls) {
                    var top = true;

                    for (var i = 1; i < ctrls.length; i++) {
                        if (ctrls[i]) {
                            top = true;
                            ctrls[i].setParent(ctrls[0]);
                        }
                    }

                    if (top) {
                        ctrls[0].$scope.children
                    }
                }
            };
        })

        app.directive("box2", function () {
            return {
                restrict: 'E',
                template: '<div class="box" >{{$id}}-{{level}},parent:{{parents.length}},children:{{children.length}}<div ng-transclude></div></div>',
                replace: true,
                transclude: true,
                require: ['box2','?^^box2', '?^box1', '?^box3'],
                controller: function ($scope) {
                    this.$scope = $scope;
                    this.$scope.level = "box2";
                    this.$scope.parents = [];
                    this.$scope.children = [];

                    this.setParent = function (ctrl) {
                        ctrl.$scope.parents.push(this);
                        this.$scope.children.push(ctrl);
                    }
                },
                scope: true,
                link: function (scope, element, attrs, ctrls) {

                    for (var i = 1; i < ctrls.length; i++) {
                        if (ctrls[i]) {
                            ctrls[i].setParent(ctrls[0]);
                        }
                    }

                }
            };
        })

        app.directive("box3", function () {
            return {
                restrict: 'E',
                template: '<div class="box" >{{$id}}-{{level}},parent:{{parents.length}},children:{{children.length}}<div ng-transclude></div></div>',
                replace: true,
                transclude: true,
                require: ['box3','?^^box3', '?^box1', '?^box2'],
                controller: function ($scope) {
                    this.$scope = $scope;
                    this.$scope.level = "box3";
                    this.$scope.parents = [];
                    this.$scope.children = [];

                    this.setParent = function (ctrl) {
                        ctrl.$scope.parents.push(this);
                        this.$scope.children.push(ctrl);
                    }
                },
                scope: true,
                link: function (scope, element, attrs, ctrls) {
                    
                    for (var i = 1; i < ctrls.length; i++) {
                        if (ctrls[i]) {
                            ctrls[i].setParent(ctrls[0]);
                        }
                    }
                }
            };
        })

    </script>

</body>
</html>
